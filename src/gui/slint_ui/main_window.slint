// ESPBrew Main Window - Slint UI Definition
import { Button, VerticalBox, HorizontalBox, ScrollView, ListView, StandardListView, TabWidget, GroupBox } from "std-widgets.slint";

// Board item model
export struct BoardItem {
    name: string,
    status: string,
    status_color: color,
    build_time: string,
    target: string,
}

// Component item model  
export struct ComponentItem {
    name: string,
    type: string,
    is_managed: bool,
    status: string,
}

// Log entry model
export struct LogEntry {
    timestamp: string,
    level: string,
    message: string,
    board_name: string,
}

export component MainWindow inherits Window {
    title: "üç∫ ESPBrew - ESP32 Multi-Platform Build Manager";
    preferred-width: 1200px;
    preferred-height: 800px;
    
    // Properties for data binding
    in property <[BoardItem]> boards;
    in property <[ComponentItem]> components;  
    in property <[LogEntry]> logs;
    in property <string> project-info: "No project detected";
    in property <string> server-status: "Disconnected";
    in property <bool> build-in-progress: false;
    in-out property <int> selected-board-index: 0;
    in-out property <int> selected-component-index: 0;
    
    // Callbacks for user actions
    callback board-selected(int);
    callback component-selected(int);
    callback build-board(int);
    callback build-all();
    callback flash-board(int);
    callback clean-board(int);
    callback discover-servers();
    callback refresh-project();
    
    background: #f5f5f5;
    
    VerticalBox {
        padding: 0px;
        spacing: 0px;
        
        // Menu Bar
        Rectangle {
            height: 32px;
            background: #e8e8e8;
            border-color: #d0d0d0;
            border-width: 1px;
            
            HorizontalBox {
                padding: 4px;
                spacing: 15px;
                alignment: start;
                
                Text {
                    text: "File";
                    color: #333;
                    font-size: 12px;
                }
                Text {
                    text: "View";
                    color: #333;
                    font-size: 12px;
                }
                Text {
                    text: "Tools";
                    color: #333; 
                    font-size: 12px;
                }
                Text {
                    text: "Help";
                    color: #333;
                    font-size: 12px;
                }
            }
        }
        
        // Main Content Area
        HorizontalBox {
            padding: 8px;
            spacing: 8px;
            
            // Left Panel (Boards + Components)
            VerticalBox {
                width: 300px;
                spacing: 8px;
                
                // Board List
                GroupBox {
                    title: "üéØ Boards";
                    min-height: 200px;
                    
                    VerticalBox {
                        spacing: 4px;
                        
                        // Board actions toolbar
                        HorizontalBox {
                            spacing: 4px;
                            
                            Button {
                                text: "Build All";
                                enabled: !build-in-progress;
                                clicked => {
                                    build-all();
                                }
                            }
                            
                            Button {
                                text: "Refresh";
                                clicked => {
                                    refresh-project();
                                }
                            }
                        }
                        
                        // Board list view
                        ScrollView {
                            ListView {
                                for board[index] in boards: Rectangle {
                                    height: 32px;
                                    background: index == selected-board-index ? #ddeeff : transparent;
                                    border-color: #ccc;
                                    border-width: index == selected-board-index ? 1px : 0px;
                                    
                                    HorizontalBox {
                                        padding: 4px;
                                        spacing: 8px;
                                        alignment: start;
                                        
                                        Rectangle {
                                            width: 12px;
                                            height: 12px;
                                            background: board.status-color;
                                            border-radius: 6px;
                                        }
                                        
                                        Text {
                                            text: board.name;
                                            color: #333;
                                            font-size: 12px;
                                            vertical-alignment: center;
                                        }
                                        
                                        if board.build-time != "": Text {
                                            text: board.build-time;
                                            color: #666;
                                            font-size: 10px;
                                            vertical-alignment: center;
                                        }
                                    }
                                    
                                    TouchArea {
                                        clicked => {
                                            selected-board-index = index;
                                            board-selected(index);
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
                
                // Component List  
                GroupBox {
                    title: "üß© Components";
                    min-height: 150px;
                    
                    ScrollView {
                        ListView {
                            for component[index] in components: Rectangle {
                                height: 28px;
                                background: index == selected-component-index ? #ddeeff : transparent;
                                border-color: #ccc;
                                border-width: index == selected-component-index ? 1px : 0px;
                                
                                HorizontalBox {
                                    padding: 4px;
                                    spacing: 8px;
                                    alignment: start;
                                    
                                    Text {
                                        text: component.is-managed ? "üì¶" : "üîß";
                                        font-size: 12px;
                                        vertical-alignment: center;
                                    }
                                    
                                    Text {
                                        text: component.name;
                                        color: #333;
                                        font-size: 11px;
                                        vertical-alignment: center;
                                    }
                                    
                                    if component.status != "": Text {
                                        text: component.status;
                                        color: #666;
                                        font-size: 10px;
                                        vertical-alignment: center;
                                    }
                                }
                                
                                TouchArea {
                                    clicked => {
                                        selected-component-index = index;
                                        component-selected(index);
                                    }
                                }
                            }
                        }
                    }
                }
            }
            
            // Right Panel (Details + Logs)
            VerticalBox {
                spacing: 8px;
                
                // Board Details
                GroupBox {
                    title: "üìã Board Details";
                    height: 120px;
                    
                    VerticalBox {
                        padding: 8px;
                        spacing: 4px;
                        
                        if boards.length > 0: HorizontalBox {
                            spacing: 8px;
                            Text {
                                text: "Board:";
                                font-weight: 700;
                                color: #333;
                                font-size: 12px;
                            }
                            Text {
                                text: selected-board-index < boards.length ? boards[selected-board-index].name : "";
                                color: #555;
                                font-size: 12px;
                            }
                        }
                        
                        if boards.length > 0: HorizontalBox {
                            spacing: 8px;
                            Text {
                                text: "Status:";
                                font-weight: 700;
                                color: #333;
                                font-size: 12px;
                            }
                            Text {
                                text: selected-board-index < boards.length ? boards[selected-board-index].status : "";
                                color: selected-board-index < boards.length ? boards[selected-board-index].status-color : #555;
                                font-size: 12px;
                            }
                        }
                        
                        if boards.length > 0: HorizontalBox {
                            spacing: 8px;
                            Text {
                                text: "Target:";
                                font-weight: 700;
                                color: #333;
                                font-size: 12px;
                            }
                            Text {
                                text: selected-board-index < boards.length ? boards[selected-board-index].target : "";
                                color: #555;
                                font-size: 12px;
                            }
                        }
                        
                        // Action buttons
                        HorizontalBox {
                            spacing: 4px;
                            
                            Button {
                                text: "Build";
                                enabled: !build-in-progress && boards.length > 0;
                                clicked => {
                                    build-board(selected-board-index);
                                }
                            }
                            
                            Button {
                                text: "Flash";
                                enabled: !build-in-progress && boards.length > 0;
                                clicked => {
                                    flash-board(selected-board-index);
                                }
                            }
                            
                            Button {
                                text: "Clean";
                                enabled: !build-in-progress && boards.length > 0;
                                clicked => {
                                    clean-board(selected-board-index);
                                }
                            }
                        }
                    }
                }
                
                // Logs Panel
                GroupBox {
                    title: "üìù Build Logs";
                    
                    ScrollView {
                        viewport-height: logs.length * 16px;
                        
                        VerticalBox {
                            spacing: 1px;
                            
                            for log[index] in logs: HorizontalBox {
                                height: 16px;
                                spacing: 8px;
                                
                                Text {
                                    text: log.timestamp;
                                    color: #666;
                                    font-size: 10px;
                                    width: 80px;
                                }
                                
                                Text {
                                    text: log.level;
                                    color: log.level == "ERROR" ? #cc0000 : (log.level == "WARN" ? #ff8800 : #333);
                                    font-size: 10px;
                                    width: 50px;
                                }
                                
                                Text {
                                    text: log.board-name;
                                    color: #0066cc;
                                    font-size: 10px;
                                    width: 100px;
                                }
                                
                                Text {
                                    text: log.message;
                                    color: #333;
                                    font-size: 10px;
                                    wrap: word-wrap;
                                }
                            }
                        }
                    }
                }
            }
        }
        
        // Status Bar
        Rectangle {
            height: 24px;
            background: #e8e8e8;
            border-color: #d0d0d0;
            border-width: 1px;
            
            HorizontalBox {
                padding: 4px;
                spacing: 20px;
                alignment: start;
                
                Text {
                    text: project-info;
                    color: #333;
                    font-size: 11px;
                    vertical-alignment: center;
                }
                
                Text {
                    text: "Server: " + server-status;
                    color: server-status == "Connected" ? #008000 : #cc0000;
                    font-size: 11px;
                    vertical-alignment: center;
                }
                
                if build-in-progress: Text {
                    text: "üîÑ Building...";
                    color: #0066cc;
                    font-size: 11px;
                    vertical-alignment: center;
                }
            }
        }
    }
}